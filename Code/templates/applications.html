{% extends "base.html" %}
{% block content %}

<!-- Add button -->
<div class="list-header">
  <a href="{{ url_for('applications.new') }}" class="add-btn">
    <span class="add-btn-icon">+</span>
    <span class="add-btn-text">Add Application</span>
  </a>
</div>

<!-- Application List -->
<div class="list">
  {% for r in rows %}
  <div class="card">
    <div class="title">{{ r.position }}</div>
    <a class="company" href="/companies/{{ r.company|urlencode }}">{{ r.company }}</a>

    <div class="status-container">
      <span class="status-label">Status:</span>

      <!-- Trigger -->
      <button
        class="status-pill {{ r.status|lower|replace(' ','') }}"
        type="button"
        onclick="openStatusMenu('{{ r.id }}', this, event)">
        {{ r.status }} <span class="dropdown-arrow">â–¼</span>
      </button>
    </div>

    <!-- Hidden form to submit status change -->
    <form id="form-{{ r.id }}" method="post"
          action="{{ url_for('applications.set_status', app_id=r.id) }}">
      <input type="hidden" name="status" value="{{ r.status }}">
    </form>
  </div>
  {% endfor %}
</div>

<!-- Floating status menu (one instance only) -->
<div id="status-menu" class="floating-menu" role="menu" aria-hidden="true">
  <button type="button" class="status-option pending"   data-status="Pending">Pending</button>
  <button type="button" class="status-option interview" data-status="Interview">Interview</button>
  <button type="button" class="status-option accepted"  data-status="Accepted">Accepted</button>
  <button type="button" class="status-option rejected"  data-status="Rejected">Rejected</button>
  <button type="button" class="status-option noanswer"  data-status="No Answer">No Answer</button>
</div>

<script>
  let CURRENT_ID = null;

  function openStatusMenu(id, btn, ev) {
    ev.stopPropagation();
    CURRENT_ID = id;

    const menu = document.getElementById('status-menu');
    const rect = btn.getBoundingClientRect();

    // position menu just under the button
    menu.style.left = (window.scrollX + rect.left) + 'px';
    menu.style.top  = (window.scrollY + rect.bottom + 6) + 'px';
    menu.classList.add('show');
    menu.setAttribute('aria-hidden', 'false');
  }

  function closeStatusMenu() {
    const menu = document.getElementById('status-menu');
    menu.classList.remove('show');
    menu.setAttribute('aria-hidden', 'true');
    CURRENT_ID = null;
  }

  // click on an option => submit hidden form
  document.getElementById('status-menu').addEventListener('click', function (e) {
    const btn = e.target.closest('.status-option');
    if (!btn || !CURRENT_ID) return;

    const status = btn.dataset.status;
    const form = document.getElementById('form-' + CURRENT_ID);
    if (!form) return;

    form.querySelector('input[name="status"]').value = status;
    closeStatusMenu();
    form.submit();
  });

  // close on outside click / scroll / resize
  document.addEventListener('click', closeStatusMenu);
  window.addEventListener('scroll', closeStatusMenu, { passive: true });
  window.addEventListener('resize', closeStatusMenu);

  // prevent clicks inside menu from bubbling to document
  document.getElementById('status-menu').addEventListener('click', function (e) {
    e.stopPropagation();
  });
</script>

{% endblock %}
